<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../style.css">
    <link rel="icon" href="../icons/PCMT Logo.png">
    <title>PCMT - Stats</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="header-bar">
        <div class="header-content" id="link-title">
            <a href="../index.html">
                <img src="../icons/PCMT Logo.png" alt="PCMT Logo" id="pcmt-logo">
            </a>
            <p>Plat Chat Members Tournament</p>
        </div>
        <nav class="header-content">
            <a class="header-link">Matches</a>
            <a class="header-link">Rankings</a>
            <a class="header-link" href="../teams/teams.html">Teams</a>
            <a class="header-link active" href="../stats/stats.html">Stats</a>
        </nav>
    </div>

    <div class="page-title-bar">
        <h1 class="page-title">Stats</h1>
    </div>

    <div class="stats-toggle-bar">
        <button class="stats-toggle-btn active" onclick="switchMainTab('player')">Player Stats</button>
        <button class="stats-toggle-btn" onclick="switchMainTab('team')">Team Stats</button>
    </div>

    <!-- ===== PLAYER STATS ===== -->
    <div class="stats-content" id="player-stats">
        <div class="stats-sub-tabs" id="player-sub-tabs">
            <button class="stats-sub-btn active" onclick="switchPlayerTab('angus')">Angus</button>
            <button class="stats-sub-btn" onclick="switchPlayerTab('pi')">pi</button>
            <button class="stats-sub-btn" onclick="switchPlayerTab('toxic')">toxic</button>
        </div>

        <p class="stats-disclaimer">*Stats may contain minor inaccuracies</p>

        <div class="stats-table-container" id="angus-stats">
            <div class="stats-loading">Loading stats...</div>
        </div>
        <div class="stats-table-container hidden" id="pi-stats">
            <div class="stats-loading">Loading stats...</div>
        </div>
        <div class="stats-table-container hidden" id="toxic-stats">
            <div class="stats-loading">Loading stats...</div>
        </div>
    </div>

    <!-- ===== TEAM STATS ===== -->
    <div class="stats-content hidden" id="team-stats">
        <div class="stats-sub-tabs" id="team-sub-tabs">
            <button class="stats-sub-btn active" onclick="switchTeamTab('pi-team')">pi</button>
            <button class="stats-sub-btn" onclick="switchTeamTab('toxic-team')">toxic</button>
        </div>

        <p class="stats-disclaimer">*Stats may contain minor inaccuracies</p>

        <div class="stats-table-container" id="pi-team-stats">
            <div class="stats-loading">Loading stats...</div>
        </div>
        <div class="stats-table-container hidden" id="toxic-team-stats">
            <div class="stats-loading">Loading stats...</div>
        </div>
    </div>

    <script>
        // ===== Sort state tracking =====
        const sortState = {};

        // ===== Main tab switching =====
        function switchMainTab(tab) {
            const playerStats = document.getElementById('player-stats');
            const teamStats = document.getElementById('team-stats');
            const buttons = document.querySelectorAll('.stats-toggle-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            if (tab === 'player') {
                playerStats.classList.remove('hidden');
                teamStats.classList.add('hidden');
                buttons[0].classList.add('active');
            } else {
                teamStats.classList.remove('hidden');
                playerStats.classList.add('hidden');
                buttons[1].classList.add('active');
            }
        }

        // ===== Player sub-tab switching =====
        function switchPlayerTab(tab) {
            const containers = {
                angus: document.getElementById('angus-stats'),
                pi: document.getElementById('pi-stats'),
                toxic: document.getElementById('toxic-stats')
            };
            const buttons = document.querySelectorAll('#player-sub-tabs .stats-sub-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            Object.values(containers).forEach(c => c.classList.add('hidden'));
            containers[tab].classList.remove('hidden');
            const idx = { angus: 0, pi: 1, toxic: 2 };
            buttons[idx[tab]].classList.add('active');
        }

        // ===== Team sub-tab switching =====
        function switchTeamTab(tab) {
            const containers = {
                'pi-team': document.getElementById('pi-team-stats'),
                'toxic-team': document.getElementById('toxic-team-stats')
            };
            const buttons = document.querySelectorAll('#team-sub-tabs .stats-sub-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            Object.values(containers).forEach(c => c.classList.add('hidden'));
            containers[tab].classList.remove('hidden');
            const idx = { 'pi-team': 0, 'toxic-team': 1 };
            buttons[idx[tab]].classList.add('active');
        }

        // ===== Render a sortable table =====
        function renderTable(headers, rows, tableId) {
            let html = `<table class="stats-table" id="table-${tableId}">`;
            html += '<thead><tr>';
            headers.forEach((h, i) => {
                html += `<th class="sortable" onclick="sortTable('${tableId}', ${i})">${h} <span class="sort-arrow"></span></th>`;
            });
            html += '</tr></thead><tbody>';
            rows.forEach(row => {
                html += '<tr>';
                row.forEach(cell => html += `<td>${cell ?? ''}</td>`);
                html += '</tr>';
            });
            html += '</tbody></table>';
            sortState[tableId] = { headers, rows: [...rows], originalRows: [...rows], currentCol: -1, clicks: 0 };
            return html;
        }

        // ===== Sort a table by column =====
        function sortTable(tableId, colIndex) {
            const state = sortState[tableId];
            if (!state) return;

            if (state.currentCol === colIndex) {
                state.clicks++;
            } else {
                state.currentCol = colIndex;
                state.clicks = 1;
            }

            let sorted;
            if (state.clicks % 3 === 0) {
                sorted = [...state.originalRows];
                state.currentCol = -1;
                state.clicks = 0;
            } else {
                const asc = state.clicks % 3 === 2;
                sorted = [...state.rows].sort((a, b) => {
                    let valA = a[colIndex];
                    let valB = b[colIndex];
                    if (typeof valA === 'string' && valA.endsWith('%')) valA = parseFloat(valA);
                    if (typeof valB === 'string' && valB.endsWith('%')) valB = parseFloat(valB);
                    const numA = parseFloat(valA);
                    const numB = parseFloat(valB);
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return asc ? numA - numB : numB - numA;
                    }
                    const strA = String(valA || '').toLowerCase();
                    const strB = String(valB || '').toLowerCase();
                    return asc ? strA.localeCompare(strB) : strB.localeCompare(strA);
                });
            }

            const table = document.getElementById(`table-${tableId}`);
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = sorted.map(row =>
                '<tr>' + row.map(cell => `<td>${cell ?? ''}</td>`).join('') + '</tr>'
            ).join('');

            // Update arrows on the last header row only
            const theadRows = table.querySelectorAll('thead tr');
            const lastHeaderRow = theadRows[theadRows.length - 1];
            const ths = lastHeaderRow.querySelectorAll('th');
            ths.forEach((th, i) => {
                const arrow = th.querySelector('.sort-arrow');
                if (i === colIndex && state.currentCol !== -1) {
                    arrow.textContent = state.clicks % 3 === 1 ? ' ▼' : ' ▲';
                } else {
                    arrow.textContent = '';
                }
            });
        }

        // ===== CSV parser =====
        function parseCSV(csvText) {
            return csvText.split('\n').map(line => {
                const cells = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        cells.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                cells.push(current.trim());
                return cells;
            }).filter(row => row.some(cell => cell !== ''));
        }

        // ===== Format helpers =====
        function formatCell(value, header) {
            if (value == null || value === '') return '';
            if (typeof value === 'number') {
                if (['KAST', 'HS%', 'CL%'].includes(header)) return (value * 100).toFixed(0) + '%';
                if (header === 'ACS') return Math.round(value);
                if (header === 'ADR') return value.toFixed(1);
                if (Number.isInteger(value)) return value;
                return value.toFixed(2);
            }
            return value;
        }

        function fmtPct(val) {
            if (val == null || val === '') return '-';
            if (typeof val === 'number') return (val * 100).toFixed(0) + '%';
            return val;
        }

        function fmtNum(val) {
            if (val == null || val === '') return '-';
            return val;
        }

        // ================================================================
        //  PLAYER STATS LOADERS
        // ================================================================

        // ===== Load toxic's Player Stats Excel =====
        async function loadToxicPlayerStats() {
            try {
                const response = await fetch('../data/Player Stats.xlsx');
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                const overallSheet = workbook.Sheets['Overall'];
                const overallData = XLSX.utils.sheet_to_json(overallSheet, { header: 1 });
                const rawHeaders = overallData[0];
                const playerRows = overallData.slice(1).filter(r => r[0]);

                const changeIdx = rawHeaders.indexOf('Change');
                let headers = [...rawHeaders];
                if (changeIdx !== -1) headers.splice(changeIdx, 1);

                const formattedRows = playerRows.map(row => {
                    let r = [...row];
                    if (changeIdx !== -1) r.splice(changeIdx, 1);
                    return r.map((cell, i) => formatCell(cell, headers[i]));
                });

                document.getElementById('toxic-stats').innerHTML = renderTable(headers, formattedRows, 'toxic');
            } catch (err) {
                document.getElementById('toxic-stats').innerHTML =
                    '<p class="stats-error">Failed to load player stats.</p>';
                console.error('Error loading toxic stats:', err);
            }
        }

        // ===== Load Angus's Google Sheet =====
        async function loadAngusStats() {
            try {
                const sheetId = '1NZNABsU_XUlmcSgjhv94KVvbRtpYji6yPjs0g2Ro3Ak';
                const gid = '821526300';
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;

                const response = await fetch(url);
                const csvText = await response.text();
                const lines = parseCSV(csvText);

                let headers = lines[0];
                let rows = lines.slice(1).filter(r => r[0] || r[1]);

                // Remove "Points" and "Agents" columns
                const removeCols = [];
                headers.forEach((h, i) => {
                    const lower = h.toLowerCase().trim();
                    if (lower === 'points' || lower === 'agents') removeCols.push(i);
                });
                removeCols.sort((a, b) => b - a).forEach(idx => {
                    headers.splice(idx, 1);
                    rows.forEach(r => r.splice(idx, 1));
                });

                document.getElementById('angus-stats').innerHTML = renderTable(headers, rows, 'angus');
            } catch (err) {
                document.getElementById('angus-stats').innerHTML =
                    '<p class="stats-error">Failed to load Angus\'s stats.</p>';
                console.error('Error loading Angus stats:', err);
            }
        }

        // ===== Load pi's Player Stats Google Sheet =====
        async function loadPiPlayerStats() {
            try {
                const sheetId = '1QkBIqtPC5jP1b1rKkn39U7z5DJJ-6SYdbWcgA6Wz7AQ';
                const gid = '1023990137';
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;

                const response = await fetch(url);
                const csvText = await response.text();
                const lines = parseCSV(csvText);

                // Row 0 is category headers (skip), row 1 is actual headers
                const allHeaders = lines[1];
                const dataRows = lines.slice(2).filter(r => r[0] || r[1]);

                const acsIdx = allHeaders.findIndex(h => h.trim().toUpperCase() === 'ACS');
                const rIdx = allHeaders.findIndex(h => h.trim().toUpperCase() === 'R');

                // Keep identifying cols (#, Team, Player) + R (Rating) + ACS onwards
                const identCols = [0, 1, 2];
                if (rIdx !== -1 && rIdx < acsIdx) identCols.push(rIdx);
                const acsCols = [];
                for (let i = acsIdx; i < allHeaders.length; i++) acsCols.push(i);
                const keepCols = [...identCols, ...acsCols];

                const headers = keepCols.map(i => allHeaders[i]);
                const rows = dataRows.map(row => keepCols.map(i => row[i] ?? ''));

                document.getElementById('pi-stats').innerHTML = renderTable(headers, rows, 'pi');
            } catch (err) {
                document.getElementById('pi-stats').innerHTML =
                    '<p class="stats-error">Failed to load pi\'s stats.</p>';
                console.error('Error loading pi stats:', err);
            }
        }

        // ================================================================
        //  TEAM STATS LOADERS
        // ================================================================

        // ===== Load pi's Team Stats Google Sheet =====
        async function loadPiTeamStats() {
            try {
                const sheetId = '1QkBIqtPC5jP1b1rKkn39U7z5DJJ-6SYdbWcgA6Wz7AQ';
                const gid = '1030932262';
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;

                const response = await fetch(url);
                const csvText = await response.text();
                const lines = parseCSV(csvText);

                // Row 0 = category headers (Series, Maps, Rounds, etc.)
                // Row 1 = column headers (#, ABBR., TEAM, W, L, etc.)
                // Row 2+ = data
                const categoryRow = lines[0];
                const headers = lines[1];
                const rows = lines.slice(2).filter(r => r[0] || r[1]);

                // Build category spans: find non-empty cells and their colspans
                const categorySpans = [];
                for (let i = 0; i < categoryRow.length; i++) {
                    if (categoryRow[i] && categoryRow[i].trim() !== '') {
                        // Count how many cols this spans (until next non-empty or end)
                        let span = 1;
                        for (let j = i + 1; j < categoryRow.length; j++) {
                            if (categoryRow[j] && categoryRow[j].trim() !== '') break;
                            span++;
                        }
                        categorySpans.push({ text: categoryRow[i].trim(), start: i, span: span });
                    }
                }

                const tableId = 'piTeam';
                let html = `<div class="stats-table-scroll"><table class="stats-table stats-table-sticky" id="table-${tableId}">`;

                // Category header row
                html += '<thead>';
                html += '<tr class="category-row">';
                let colCovered = 0;
                categorySpans.forEach(cat => {
                    // Fill any gap
                    if (cat.start > colCovered) {
                        html += `<th colspan="${cat.start - colCovered}"></th>`;
                    }
                    html += `<th colspan="${cat.span}" class="category-header">${cat.text}</th>`;
                    colCovered = cat.start + cat.span;
                });
                if (colCovered < headers.length) {
                    html += `<th colspan="${headers.length - colCovered}"></th>`;
                }
                html += '</tr>';

                // Actual column headers
                html += '<tr>';
                headers.forEach((h, i) => {
                    html += `<th class="sortable" onclick="sortTableWithCategory('${tableId}', ${i})">${h} <span class="sort-arrow"></span></th>`;
                });
                html += '</tr></thead><tbody>';

                rows.forEach(row => {
                    html += '<tr>';
                    row.forEach(cell => html += `<td>${cell ?? ''}</td>`);
                    html += '</tr>';
                });
                html += '</tbody></table></div>';

                sortState[tableId] = { headers, rows: [...rows], originalRows: [...rows], currentCol: -1, clicks: 0 };
                document.getElementById('pi-team-stats').innerHTML = html;

            } catch (err) {
                document.getElementById('pi-team-stats').innerHTML =
                    '<p class="stats-error">Failed to load pi\'s team stats.</p>';
                console.error('Error loading pi team stats:', err);
            }
        }

        // Sort for tables with category headers (same logic, different table structure)
        function sortTableWithCategory(tableId, colIndex) {
            sortTable(tableId, colIndex);
        }

        // ===== Load toxic's Team Map Stats Excel =====
        let toxicTeamWorkbook = null;

        async function loadToxicTeamStats() {
            try {
                const response = await fetch('../data/Team Map Stats.xlsx');
                const arrayBuffer = await response.arrayBuffer();
                toxicTeamWorkbook = XLSX.read(arrayBuffer, { type: 'array' });

                // Get team names (non-Comps sheets)
                const teamNames = toxicTeamWorkbook.SheetNames.filter(s => !s.includes('Comps'));

                // Build team selector + table container
                let html = '<div class="team-selector-bar">';
                html += '<label for="toxic-team-select">Select Team: </label>';
                html += '<select id="toxic-team-select" onchange="renderToxicTeamMap(this.value)">';
                teamNames.forEach((t, i) => {
                    html += `<option value="${t}" ${i === 0 ? 'selected' : ''}>${t}</option>`;
                });
                html += '</select></div>';
                html += '<div id="toxic-team-map-table"></div>';

                document.getElementById('toxic-team-stats').innerHTML = html;
                renderToxicTeamMap(teamNames[0]);
            } catch (err) {
                document.getElementById('toxic-team-stats').innerHTML =
                    '<p class="stats-error">Failed to load team map stats.</p>';
                console.error('Error loading toxic team stats:', err);
            }
        }

        function renderToxicTeamMap(teamName) {
            if (!toxicTeamWorkbook) return;
            const ws = toxicTeamWorkbook.Sheets[teamName];
            const data = XLSX.utils.sheet_to_json(ws, { header: 1 });

            const mapHeaders = ['Map', 'Pick', 'Ban', 'Played', 'Won', 'Win%', 'RND', 'RND Won', 'RND%', 'Atk%', 'Def%'];
            const mapRows = [];
            let overallAtk = null;
            let overallDef = null;

            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (row[0] === 'Atk%') overallAtk = row[2];
                if (row[0] === 'Def%') overallDef = row[2];
            }

            for (let startRow = 0; startRow < data.length; startRow += 4) {
                if (startRow + 2 >= data.length) break;
                const nameRow = data[startRow];
                const dataRow = data[startRow + 2];

                // Skip if this is the overall stats rows
                if (nameRow[0] === 'Atk%' || nameRow[0] === 'Def%') continue;

                // Left map (cols 0-9)
                const leftMap = nameRow[0];
                if (leftMap) {
                    const d = dataRow.slice(0, 10);
                    mapRows.push([
                        leftMap, fmtNum(d[0]), fmtNum(d[1]),
                        fmtNum(d[2]), fmtNum(d[3]), fmtPct(d[4]),
                        fmtNum(d[5]), fmtNum(d[6]), fmtPct(d[7]),
                        fmtPct(d[8]), fmtPct(d[9])
                    ]);
                }

                // Right map (cols 11-20)
                const rightMap = nameRow[11];
                if (rightMap) {
                    const d = dataRow.slice(11, 21);
                    mapRows.push([
                        rightMap, fmtNum(d[0]), fmtNum(d[1]),
                        fmtNum(d[2]), fmtNum(d[3]), fmtPct(d[4]),
                        fmtNum(d[5]), fmtNum(d[6]), fmtPct(d[7]),
                        fmtPct(d[8]), fmtPct(d[9])
                    ]);
                }
            }

            // Filter out maps with no data
            const filteredRows = mapRows.filter(row =>
                row.slice(1).some(cell => cell !== '-')
            );

            // Sort alphabetically by map name
            filteredRows.sort((a, b) => String(a[0]).localeCompare(String(b[0])));

            // Build overall summary + table
            let html = '';
            if (overallAtk != null || overallDef != null) {
                html += '<div class="team-overall-bar">';
                html += '<div class="overall-stat"><span class="overall-label">Overall Atk%</span><span class="overall-value">' + fmtPct(overallAtk) + '</span></div>';
                html += '<div class="overall-stat"><span class="overall-label">Overall Def%</span><span class="overall-value">' + fmtPct(overallDef) + '</span></div>';
                html += '</div>';
            }
            html += renderTable(mapHeaders, filteredRows, 'toxicTeamMap');

            document.getElementById('toxic-team-map-table').innerHTML = html;
        }

        // ===== Load everything =====
        loadToxicPlayerStats();
        loadAngusStats();
        loadPiPlayerStats();
        loadPiTeamStats();
        loadToxicTeamStats();
    </script>
</body>
</html>