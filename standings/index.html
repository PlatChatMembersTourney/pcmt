<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../style.css">
    <link rel="icon" href="../icons/PCMT Logo.png">
    <title>PCMT - standings</title>
    <style>
        .bracket-date {
            font-size: 0.7em;
            color: #888;
            font-weight: 400;
            margin-left: 6px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div id="header-bar">
        <div class="header-inner">
        <div class="header-content" id="link-title">
            <a href="../">
                <img src="../icons/PCMT Logo.png" alt="PCMT Logo" id="pcmt-logo">
            </a>
            <p>Plat Chat Members Tournament</p>
        </div>
        <nav class="header-content">
            <a class="header-link" href="../">Home</a>
            <a class="header-link" href="../matches/">Matches</a>
            <a class="header-link active" href="../standings/">standings</a>
            <a class="header-link" href="../teams/">Teams</a>
            <a class="header-link" href="../stats/">Stats</a>
            <div class="header-buffer"></div>
        </nav>
        </div>
    </div>

    <div class="page-container">
    <div class="page-title-bar">
        <h1 class="page-title">standings</h1>
    </div>

    <div class="season-selector-bar">
        <button class="season-sel-btn" onclick="switchSeason(1)">Season 1 <span class="under-review-tag">(Under Review)</span></button>
        <button class="season-sel-btn" onclick="switchSeason(2)">Season 2</button>
    </div>

    <div class="stats-sub-tabs" id="stage-tabs" style="display:none;">
        <button class="stats-sub-btn active" onclick="switchStage('groups')">Group Stage</button>
        <button class="stats-sub-btn" onclick="switchStage('lcq')">LCQ</button>
        <button class="stats-sub-btn" onclick="switchStage('playoffs')">Playoffs</button>
    </div>

    <div class="standings-content" id="standings-area">
        <div class="stats-loading">Loading standings...</div>
    </div>

    <script>
        let currentSeason = 2;
        let currentStage = 'groups';

        function cacheGet(key) {
            try { return sessionStorage.getItem('pcmt-rank-' + key); } catch(e) { return null; }
        }
        function cacheSet(key, val) {
            try { sessionStorage.setItem('pcmt-rank-' + key, val); } catch(e) {}
        }

        function switchSeason(season) {
            currentSeason = season;
            const buttons = document.querySelectorAll('.season-sel-btn');
            buttons.forEach((btn, i) => btn.classList.toggle('active', i === season - 1));

            const stageTabs = document.getElementById('stage-tabs');
            stageTabs.style.display = (season === 2) ? '' : 'none';

            loadstandings();
        }

        function switchStage(stage) {
            currentStage = stage;
            const buttons = document.querySelectorAll('#stage-tabs .stats-sub-btn');
            const stages = ['groups', 'lcq', 'playoffs'];
            buttons.forEach((btn, i) => btn.classList.toggle('active', stages[i] === stage));
            loadstandings();
        }

        function parseCSV(csvText) {
            return csvText.split('\n').map(line => {
                const cells = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        cells.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                cells.push(current.trim());
                return cells;
            });
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            const parts = dateStr.split('-');
            if (parts.length < 3) return dateStr;
            const month = months[parseInt(parts[1], 10) - 1] || '';
            const day = parseInt(parts[2], 10);
            return `${month} ${day}`;
        }

        function loadstandings() {
            const area = document.getElementById('standings-area');

            if (currentSeason === 1) {
                area.innerHTML = '<div class="standings-empty"><p>Season 1 standings are currently under review.</p></div>';
                return;
            }

            if (currentStage === 'lcq') {
                area.innerHTML = '<div class="stats-loading">Loading bracket...</div>';
                loadLCQBracket();
                return;
            }

            if (currentStage === 'playoffs') {
                area.innerHTML = '<div class="standings-empty"><p>Playoff bracket will be available once playoffs begin.</p></div>';
                return;
            }

            // Group Stage
            if (cacheGet('s2-groups')) {
                area.innerHTML = cacheGet('s2-groups');
                return;
            }

            area.innerHTML = '<div class="stats-loading">Loading standings...</div>';
            loadS2Groups();
        }

        async function loadS2Groups() {
            const area = document.getElementById('standings-area');

            try {
                const sheetId = '16ylGbnoG4kfrqp_N6MxE6tjDLM_Lo7adorzKHHBQTp8';
                const gid = '1622887646';
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch');
                const csvText = await response.text();
                const lines = parseCSV(csvText);

                // --- scoreboard ---
                const teamRows = [];
                let lastScoreboardIdx = 0;
                for (let i = 0; i < lines.length; i++) {
                    const row = lines[i];
                    const rankCell = (row[1] || '').trim();
                    if (/^\d+\)$/.test(rankCell)) {
                        teamRows.push({
                            rank: parseInt(rankCell),
                            abbr: (row[3] || '').trim(),
                            name: (row[5] || '').trim(),
                            matchW: row[9] || '',
                            matchL: row[10] || '',
                            mapW: row[11] || '',
                            mapL: row[12] || '',
                            mapDiff: row[13] || '',
                            rndW: row[14] || '',
                            rndL: row[15] || '',
                            rndDiff: row[16] || ''
                        });
                        lastScoreboardIdx = i;
                    }
                }

                // --- head-to-head matrix ---
                let h2hLabelRowIdx = -1;
                for (let i = lines.length - 1; i >= 0; i--) {
                    const row = lines[i];
                    if ((row[4] || '').trim() && (row[5] || '').trim() && (row[6] || '').trim()) {
                        const possibleTeams = row.slice(4, 16).map(c => (c || '').trim()).filter(Boolean);
                        if (possibleTeams.length >= 10) {
                            h2hLabelRowIdx = i;
                            break;
                        }
                    }
                }

                const h2hTeams = h2hLabelRowIdx >= 0
                    ? lines[h2hLabelRowIdx].slice(4, 16).map(c => (c || '').trim())
                    : [];

                const h2hData = [];
                if (h2hLabelRowIdx >= 0) {
                    for (let i = 0; i < lines.length; i++) {
                        const row = lines[i];
                        const teamCell = (row[3] || '').trim();
                        if (teamCell && i > lastScoreboardIdx && i < h2hLabelRowIdx) {
                            const scores = row.slice(4, 16).map(c => (c || '').trim());
                            const hasScore = scores.some(s => /^\d+-\d+$/.test(s));
                            if (hasScore) {
                                h2hData.push({ team: teamCell, scores: scores });
                            }
                        }
                    }
                }

                // render scoreboard
                let html = '<div class="standings-section">';
                html += '<div class="stats-table-scroll"><table class="stats-table stats-table-sticky standings-table">';

                html += '<thead><tr class="category-row">';
                html += '<th colspan="3"></th>';
                html += '<th colspan="2" class="category-header">Matches</th>';
                html += '<th colspan="3" class="category-header">Maps</th>';
                html += '<th colspan="3" class="category-header">Rounds</th>';
                html += '</tr>';

                html += '<tr>';
                html += '<th>#</th><th>ABBR.</th><th>TEAM</th>';
                html += '<th>W</th><th>L</th>';
                html += '<th>W</th><th>L</th><th>Δ</th>';
                html += '<th>W</th><th>L</th><th>Δ</th>';
                html += '</tr></thead><tbody>';

                teamRows.forEach(t => {
                    const diffClass = val => {
                        const n = parseInt(val);
                        if (isNaN(n)) return '';
                        if (n > 0) return ' class="diff-pos"';
                        if (n < 0) return ' class="diff-neg"';
                        return '';
                    };
                    const fmtDiff = val => {
                        const n = parseInt(val);
                        if (isNaN(n)) return val;
                        return n > 0 ? `+${n}` : `${n}`;
                    };

                    let rowClass = '';
                    if (t.rank <= 2) rowClass = 'rank-playoffs';
                    else if (t.rank <= 6) rowClass = 'rank-lcq';
                    else rowClass = 'rank-eliminated';

                    html += `<tr class="${rowClass}">`;
                    html += `<td>${t.rank}</td>`;
                    html += `<td class="team-abbr-cell"><a href="../teams/team/?team=${t.abbr}&season=${currentSeason}" class="team-link">${t.abbr}</a></td>`;
                    html += `<td><a href="../teams/team/?team=${t.abbr}&season=${currentSeason}" class="team-link">${t.name}</a></td>`;
                    html += `<td>${t.matchW}</td><td>${t.matchL}</td>`;
                    html += `<td>${t.mapW}</td><td>${t.mapL}</td>`;
                    html += `<td${diffClass(t.mapDiff)}>${fmtDiff(t.mapDiff)}</td>`;
                    html += `<td>${t.rndW}</td><td>${t.rndL}</td>`;
                    html += `<td${diffClass(t.rndDiff)}>${fmtDiff(t.rndDiff)}</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table></div>';
                html += '</div>';

                // render H2H matrix
                if (h2hData.length > 0 && h2hTeams.length > 0) {
                    html += '<div class="standings-section">';
                    html += '<h2 class="standings-subtitle">Head-to-Head</h2>';
                    html += '<div class="h2h-scroll"><table class="stats-table h2h-table">';

                    html += '<thead><tr><th></th>';
                    h2hTeams.forEach(t => html += `<th class="h2h-header">${t}</th>`);
                    html += '</tr></thead><tbody>';

                    h2hData.forEach(row => {
                        html += '<tr>';
                        html += `<th class="h2h-row-label"><a href="../teams/team/?team=${row.team}&season=${currentSeason}" class="team-link">${row.team}</a></th>`;
                        row.scores.forEach((score, i) => {
                            if (!score || row.team === h2hTeams[i]) {
                                html += '<td class="h2h-self"></td>';
                            } else {
                                const parts = score.split('-').map(Number);
                                let cls = 'h2h-cell';
                                if (parts.length === 2) {
                                    if (parts[0] > parts[1]) cls += ' h2h-win';
                                    else if (parts[0] < parts[1]) cls += ' h2h-loss';
                                }
                                html += `<td class="${cls}">${score}</td>`;
                            }
                        });
                        html += '</tr>';
                    });

                    html += '</tbody></table></div>';
                    html += '</div>';
                }

                cacheSet('s2-groups', html);
                area.innerHTML = html;
            } catch (err) {
                area.innerHTML = '<div class="stats-table-container"><p class="stats-error">Failed to load standings. The sheet may not be publicly shared.</p></div>';
                console.error('standings error:', err);
            }
        }

        async function loadLCQBracket() {
            const area = document.getElementById('standings-area');

            // LCQ seeds from group stage (3rd vs 6th, 4th vs 5th)
            const seeds = {
                opening1: ['JDG', 'MIBR'],
                opening2: ['ZIRC', 'DRG']
            };

            // Load matches and teams
            let matches = [];
            let teams = {};
            try {
                const res = await fetch(`../data/s${currentSeason}/matches/matches.json`);
                if (res.ok) matches = await res.json();
            } catch(e) {}
            try {
                const res = await fetch(`../data/s${currentSeason}/teams.json`);
                if (res.ok) teams = await res.json();
            } catch(e) {}

            function logoFor(abbr) {
                if (!abbr || !teams[abbr]) return '';
                const logo = teams[abbr].logo.replace(/^(\.\.\/)+/, '');
                return `<img src="../${logo}" alt="${abbr}" class="bracket-team-logo" onerror="this.style.display='none'">`;
            }

            const lcqMatches = matches.filter(m => m.stage && m.stage.toLowerCase().includes('lcq'));

            function findMatch(t1, t2) {
                if (!t1 || !t2) return null;
                return lcqMatches.find(m =>
                    (m.team1 === t1 && m.team2 === t2) ||
                    (m.team1 === t2 && m.team2 === t1)
                ) || null;
            }
            function getWinner(m) {
                if (!m || !m.completed) return null;
                return m.score1 > m.score2 ? m.team1 : m.team2;
            }
            function getLoser(m) {
                if (!m || !m.completed) return null;
                return m.score1 > m.score2 ? m.team2 : m.team1;
            }

            const o1 = findMatch(seeds.opening1[0], seeds.opening1[1]);
            const o2 = findMatch(seeds.opening2[0], seeds.opening2[1]);
            const w1 = getWinner(o1), w2 = getWinner(o2);
            const l1 = getLoser(o1), l2 = getLoser(o2);
            const wMatch = findMatch(w1, w2);
            const eMatch = findMatch(l1, l2);
            const wLoser = getLoser(wMatch);
            const eWinner = getWinner(eMatch);
            const dMatch = findMatch(wLoser, eWinner);

            function slot(label, m, fb1, fb2) {
                const t1 = m ? m.team1 : fb1;
                const t2 = m ? m.team2 : fb2;
                const s1 = m && m.completed ? m.score1 : null;
                const s2 = m && m.completed ? m.score2 : null;
                const date = m ? m.date : null;
                return { label, match: m, team1: t1 || 'TBD', team2: t2 || 'TBD', score1: s1, score2: s2, date };
            }

            const bracket = {
                opening1: slot('Opening', o1, seeds.opening1[0], seeds.opening1[1]),
                opening2: slot('Opening', o2, seeds.opening2[0], seeds.opening2[1]),
                winners:  slot("Winner's", wMatch, w1 || 'Winner M1', w2 || 'Winner M2'),
                elim:     slot('Elimination', eMatch, l1 || 'Loser M1', l2 || 'Loser M2'),
                decider:  slot('Decider', dMatch, wLoser || 'Loser M3', eWinner || 'Winner M4')
            };

            area.innerHTML = renderLCQBracket(bracket, logoFor);
        }

        function renderLCQBracket(bracket, logoFor) {
            function matchBox(s) {
                const s1 = s.score1 !== null ? s.score1 : '-';
                const s2 = s.score2 !== null ? s.score2 : '-';
                const w1 = s.score1 !== null && s.score2 !== null && s.score1 > s.score2;
                const w2 = s.score1 !== null && s.score2 !== null && s.score2 > s.score1;
                const hasMatch = !!s.match;
                const upcoming = s.match && !s.match.completed;
                const href = hasMatch ? `../matches/match.html?id=${s.match.id}&season=${currentSeason}` : null;
                const tag = href ? 'a' : 'div';
                const hrefAttr = href ? ` href="${href}"` : '';
                const cls = 'bracket-box' + (upcoming ? ' bracket-upcoming' : '') + (href ? ' bracket-clickable' : '');

                const dateTag = s.date ? `<span class="bracket-date">${formatDate(s.date)}</span>` : '';

                return `
                    <div class="bracket-match">
                        <div class="bracket-label">${s.label}${dateTag}</div>
                        <${tag}${hrefAttr} class="${cls}">
                            <div class="bracket-team ${w1 ? 'bracket-winner' : ''}">
                                <div class="bracket-team-info">${logoFor(s.team1)}<span class="bracket-team-name">${s.team1}</span></div>
                                <span class="bracket-team-score">${s1}</span>
                            </div>
                            <div class="bracket-team ${w2 ? 'bracket-winner' : ''}">
                                <div class="bracket-team-info">${logoFor(s.team2)}<span class="bracket-team-name">${s.team2}</span></div>
                                <span class="bracket-team-score">${s2}</span>
                            </div>
                        </${tag}>
                    </div>`;
            }

            function qualBox() {
                return `<div class="bracket-qual"><div class="bracket-qual-tag">Qualified</div></div>`;
            }

            function conn(type) {
                if (type === 'merge') return `<div class="bracket-connector bracket-conn-upper">
                    <svg viewBox="0 0 60 200" preserveAspectRatio="none">
                        <line x1="0" y1="50" x2="30" y2="50" stroke="#555" stroke-width="2" stroke-dasharray="6,4"/>
                        <line x1="30" y1="50" x2="30" y2="150" stroke="#555" stroke-width="2" stroke-dasharray="6,4"/>
                        <line x1="0" y1="150" x2="30" y2="150" stroke="#555" stroke-width="2" stroke-dasharray="6,4"/>
                        <line x1="30" y1="100" x2="60" y2="100" stroke="#555" stroke-width="2" stroke-dasharray="6,4"/>
                    </svg></div>`;
                return `<div class="bracket-connector bracket-conn-single">
                    <svg viewBox="0 0 60 20" preserveAspectRatio="none">
                        <line x1="0" y1="10" x2="60" y2="10" stroke="#555" stroke-width="2" stroke-dasharray="6,4"/>
                    </svg></div>`;
            }

            return `
                <div class="bracket-container">
                    <div class="bracket-upper">
                        <div class="bracket-col bracket-col-opening">
                            ${matchBox(bracket.opening1)}
                            ${matchBox(bracket.opening2)}
                        </div>
                        ${conn('merge')}
                        <div class="bracket-col bracket-col-mid">${matchBox(bracket.winners)}</div>
                        ${conn('single')}
                        <div class="bracket-col bracket-col-qual">${qualBox()}</div>
                    </div>
                    <div class="bracket-lower">
                        <div class="bracket-col bracket-col-opening">${matchBox(bracket.elim)}</div>
                        ${conn('single')}
                        <div class="bracket-col bracket-col-mid">${matchBox(bracket.decider)}</div>
                        ${conn('single')}
                        <div class="bracket-col bracket-col-qual">${qualBox()}</div>
                    </div>
                </div>`;
        }

        switchSeason(2);

    </script>
    </div>
</body>
</html>