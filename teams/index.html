<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../style.css">
    <link rel="icon" href="../icons/PCMT Logo.png">
    <title>PCMT - Teams</title>
</head>
<body>
    <div id="header-bar">
        <div class="header-inner">
        <div class="header-content" id="link-title">
            <a href="../">
                <img src="../icons/PCMT Logo.png" alt="PCMT Logo" id="pcmt-logo">
            </a>
            <p>Plat Chat Members Tournament</p>
        </div>
        <nav class="header-content">
            <a class="header-link" href="../">Home</a>
            <a class="header-link" href="../matches/">Matches</a>
            <a class="header-link" href="../standings/">Standings</a>
            <a class="header-link active" href="../teams/">Teams</a>
            <a class="header-link" href="../stats/">Stats</a>
            <div class="header-buffer"></div>
        </nav>
        </div>
    </div>

    <div class="page-container">
    <div class="page-title-bar">
        <h1 class="page-title">Teams</h1>
    </div>

    <div class="season-container">
        <button class="season-toggle" onclick="toggleSeason('season1')">
            <span class="season-label">Season 1</span>
            <span class="toggle-icon" id="season1-icon">▸</span>
        </button>
        <div class="season-content" id="season1">
            <div class="teams-grid" id="grid-s1"></div>
        </div>
    </div>

    <div class="season-container">
        <button class="season-toggle" onclick="toggleSeason('season2')">
            <span class="season-label">Season 2 <span class="ongoing-tag">(Ongoing)</span></span>
            <span class="toggle-icon" id="season2-icon">▸</span>
        </button>
        <div class="season-content" id="season2">
            <div class="teams-grid" id="grid-s2"></div>
        </div>
    </div>

    <script>
        const teamData = {};

        const s1Cards = [
            { abbr: 'CIN', name: 'Absolute Cinema', logo: '../icons/s1_teams/Absolute Cinema.png', region: 'na' },
            { abbr: 'KAT', name: "Kurt's Kittens", logo: "../icons/s1_teams/Kurt's Kittens.png", region: 'na' },
            { abbr: 'WALL', name: 'The Brick Wall', logo: '../icons/s1_teams/The Brick Wall.png', region: 'na' },
            { abbr: 'YGSYD', name: 'You Get Shot You Die', logo: '../icons/s1_teams/You Get Shot You Die.png', region: 'na' }
        ];

        const s2Cards = [
            { abbr: 'EMEA', name: 'Tech Pause Esports', logo: '../icons/s2_teams/TechPauseEsports.png', region: 'na' },
            { abbr: 'WING', name: 'Wingman Warriors', logo: '../icons/s2_teams/WingmanWarriors.png', region: 'na' },
            { abbr: 'JDG', name: 'Just Dudes Gaming', logo: '../icons/s2_teams/JustDudesGaming.png', region: 'na' },
            { abbr: 'ZIRC', name: 'Zirconians', logo: '../icons/s2_teams/Zirconians.png', region: 'na' },
            { abbr: 'DRG', name: 'DeRank Gamers', logo: '../icons/s2_teams/DeRankGamers.png', region: 'na' },
            { abbr: 'MIBR', name: 'Made in Bronze', logo: '../icons/s2_teams/MadeInBronze.png', region: 'na' },
            { abbr: 'KOI', name: 'Keep On Inting', logo: '../icons/s2_teams/KeepOnInting.png', region: 'na' },
            { abbr: 'SLLY', name: 'Silly Geese', logo: '../icons/s2_teams/SillyGeese.png', region: 'na' },
            { abbr: 'DRX', name: 'Dementia Real Exists', logo: '../icons/s2_teams/DementiaRealExists.png', region: 'na' },
            { abbr: 'WOOD', name: 'The Wooden Fence', logo: '../icons/s2_teams/TheWoodenFence.png', region: 'na' },
            { abbr: 'KRU', name: "Knives R' Us", logo: '../icons/s2_teams/KnivesRUs.png', region: 'na' },
            { abbr: 'TS', name: 'Tequila Sunrise', logo: '../icons/s2_teams/TequilaSunrise.png', region: 'na' }
        ];

        function buildGrid(gridId, cards, season) {
            const grid = document.getElementById(gridId);
            cards.forEach(card => {
                const div = document.createElement('div');
                div.className = 'team-card';
                div.dataset.abbr = card.abbr;
                div.dataset.season = season;
                div.innerHTML = `<img src="${card.logo}" alt="${card.name}" class="team-logo"><h3 class="team-name">${card.name}</h3>`;
                div.onclick = () => toggleExpand(div, card, season);
                grid.appendChild(div);
            });
        }

        function toggleExpand(cardEl, card, season) {
            const grid = cardEl.parentElement;
            const existingPanel = grid.querySelector(`.team-expand[data-abbr="${card.abbr}"]`);

            if (existingPanel && existingPanel.classList.contains('open')) {
                existingPanel.classList.remove('open');
                cardEl.classList.remove('expanded');
                setTimeout(() => existingPanel.remove(), 10);
                return;
            }

            const openPanel = grid.querySelector('.team-expand.open');
            if (openPanel) {
                openPanel.classList.remove('open');
                const openCard = grid.querySelector('.team-card.expanded');
                if (openCard) openCard.classList.remove('expanded');
                openPanel.remove();
            }

            const cardRect = cardEl.getBoundingClientRect();
            const allCards = [...grid.querySelectorAll('.team-card')];
            let lastInRow = cardEl;
            for (const c of allCards) {
                const r = c.getBoundingClientRect();
                if (Math.abs(r.top - cardRect.top) < 10) lastInRow = c;
            }

            const panel = document.createElement('div');
            panel.className = 'team-expand';
            panel.dataset.abbr = card.abbr;

            const key = `s${season}`;
            const roster = teamData[key] && teamData[key][card.abbr] ? teamData[key][card.abbr].players : null;
            const sortedRoster = roster ? [...roster].sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase())) : [];
            const regionParam = card.region || 'na';

            panel.innerHTML = `
                <div class="team-expand-header">
                    <img src="${card.logo}" class="team-expand-logo" onerror="this.style.display='none'">
                    <div>
                        <div class="team-expand-name">${card.name}</div>
                        <div class="team-expand-abbr">${card.abbr} · Season ${season}</div>
                    </div>
                </div>
                <div class="team-expand-roster">
                    ${sortedRoster.length > 0
                        ? sortedRoster.map(p => `<span class="team-expand-player">${p}</span>`).join('')
                        : '<span style="color:#777">Roster not available</span>'}
                </div>
                <a href="team/?team=${card.abbr}&season=${season}&region=${regionParam}" class="team-expand-link">View full page →</a>
            `;

            lastInRow.after(panel);
            requestAnimationFrame(() => panel.classList.add('open'));
            cardEl.classList.add('expanded');
        }

        const seasonMetaCache = {};

        async function loadRosters() {
            try {
                for (const s of [1, 2]) {
                    let meta;
                    try {
                        const res = await fetch(`../data/events/s${s}/season.json`);
                        meta = await res.json();
                    } catch(e) {
                        meta = { regions: [{ id: 'na', name: 'NA' }] };
                    }
                    seasonMetaCache[s] = meta;
                    teamData[`s${s}`] = {};
                    const regionTeams = {};
                    for (const r of meta.regions) {
                        try {
                            const res = await fetch(`../data/events/s${s}/${r.id}/teams.json`);
                            const data = await res.json();
                            regionTeams[r.id] = data;
                            Object.assign(teamData[`s${s}`], data);
                        } catch(e) {}
                    }

                    if (meta.regions.length > 1) {
                        rebuildGridByRegion(s, meta, regionTeams);
                    }
                }
            } catch (err) {}
        }

        function rebuildGridByRegion(season, meta, regionTeams) {
            const container = document.getElementById(`season${season}`);
            if (!container) return;
            container.innerHTML = '';
            for (const r of meta.regions) {
                const data = regionTeams[r.id];
                if (!data || Object.keys(data).length === 0) continue;
                const header = document.createElement('h3');
                header.className = 'region-grid-header';
                header.textContent = r.name;
                container.appendChild(header);
                const grid = document.createElement('div');
                grid.className = 'teams-grid';
                grid.id = `grid-s${season}-${r.id}`;
                container.appendChild(grid);
                const cards = Object.entries(data).map(([abbr, t]) => ({
                    abbr, name: t.name, logo: t.logo, region: r.id
                }));
                cards.sort((a, b) => a.name.localeCompare(b.name));
                buildGrid(grid.id, cards, season);
            }
        }

        function toggleSeason(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById(id + '-icon');
            content.classList.toggle('open');
            icon.textContent = content.classList.contains('open') ? '▾' : '▸';
        }

        window.addEventListener('pageshow', () => {
            document.getElementById('season1').classList.remove('open');
            document.getElementById('season1-icon').textContent = '▸';
            document.getElementById('season2').classList.remove('open');
            document.getElementById('season2-icon').textContent = '▸';
        });

        buildGrid('grid-s1', s1Cards, 1);
        buildGrid('grid-s2', s2Cards, 2);
        loadRosters();
    </script>
    </div>
</body>
</html>