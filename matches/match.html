<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../style.css">
    <link rel="icon" href="../icons/PCMT Logo.png">
    <title>PCMT - Match</title>
</head>
<body>
    <div id="header-bar">
        <div class="header-inner">
        <div class="header-content" id="link-title">
            <a href="../">
                <img src="../icons/PCMT Logo.png" alt="PCMT Logo" id="pcmt-logo">
            </a>
            <p>Plat Chat Members Tournament</p>
        </div>
        <nav class="header-content">
            <a class="header-link" href="../">Home</a>
            <a class="header-link active" href="../matches/">Matches</a>
            <a class="header-link" href="../standings/">Standings</a>
            <a class="header-link" href="../teams/">Teams</a>
            <a class="header-link" href="../stats/">Stats</a>
            <div class="header-buffer"></div>
        </nav>
        </div>
    </div>

    <div class="page-container">
        <div id="match-detail">
            <div class="stats-loading">Loading match...</div>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const matchId = params.get('id');
        const season = parseInt(params.get('season')) || 2;
        let match = null;
        let teams = {};
        let currentMapTab = 'all';

        function logoFor(abbr, cls) {
            if (!abbr || !teams[abbr]) return '';
            const logo = teams[abbr].logo.replace(/^(\.\.\/)+/, '');
            return `<img src="../${logo}" alt="${abbr}" class="${cls || 'md-team-logo'}" onerror="this.style.display='none'">`;
        }

        async function loadMatch() {
            const container = document.getElementById('match-detail');
            if (!matchId) {
                container.innerHTML = '<p class="stats-error">No match specified.</p>';
                return;
            }

            try {
                const [matchRes, teamsRes] = await Promise.all([
                    fetch(`../data/s${season}/matches/matches.json`),
                    fetch(`../data/s${season}/teams.json`)
                ]);
                if (!matchRes.ok) throw new Error();
                const matches = await matchRes.json();
                if (teamsRes.ok) teams = await teamsRes.json();
                match = matches.find(m => m.id === matchId);

                if (!match) {
                    container.innerHTML = '<p class="stats-error">Match not found.</p>';
                    return;
                }

                document.title = `PCMT - ${match.team1} vs ${match.team2}`;
                renderMatch(container);
            } catch (err) {
                container.innerHTML = '<p class="stats-error">Failed to load match.</p>';
            }
        }

        function renderMatch(container) {
            const winner = match.score1 > match.score2 ? 1 : match.score2 > match.score1 ? 2 : 0;

            let html = '';

            // --- Header ---
            html += '<div class="md-header">';
            html += `<div class="md-stage-tag">${match.stage || 'Match'}${match.date ? ' · ' + match.date : ''}</div>`;
            html += '<div class="md-teams-row">';

            html += `<div class="md-team md-team-left ${winner === 1 ? 'md-winner' : ''}">`;
            html += `<a href="../teams/team/?team=${match.team1}&season=${season}" class="md-team-info">`;
            html += `<span class="md-team-name">${match.team1Name}</span>`;
            html += `<span class="md-team-abbr">${match.team1}</span>`;
            html += `</a>`;
            html += logoFor(match.team1, 'md-team-logo');
            html += `</div>`;

            html += '<div class="md-score-box">';
            html += `<span class="md-score ${winner === 1 ? 'md-score-win' : 'md-score-loss'}">${match.score1}</span>`;
            html += '<span class="md-score-sep">:</span>';
            html += `<span class="md-score ${winner === 2 ? 'md-score-win' : 'md-score-loss'}">${match.score2}</span>`;
            html += '</div>';

            html += `<div class="md-team md-team-right ${winner === 2 ? 'md-winner' : ''}">`;
            html += logoFor(match.team2, 'md-team-logo');
            html += `<a href="../teams/team/?team=${match.team2}&season=${season}" class="md-team-info">`;
            html += `<span class="md-team-name">${match.team2Name}</span>`;
            html += `<span class="md-team-abbr">${match.team2}</span>`;
            html += `</a></div>`;

            html += '</div>';

            // Map score pills
            if (match.maps && match.maps.length > 0) {
                html += '<div class="md-map-scores">';
                match.maps.forEach(map => {
                    const mw = map.score1 > map.score2 ? 1 : 2;
                    html += '<div class="md-map-pill">';
                    html += `<span class="md-map-pill-name">${map.name}</span>`;
                    html += `<span class="md-map-pill-score">`;
                    html += `<span class="${mw === 1 ? 'md-pill-win' : 'md-pill-loss'}">${map.score1}</span>`;
                    html += `<span class="md-pill-sep">-</span>`;
                    html += `<span class="${mw === 2 ? 'md-pill-win' : 'md-pill-loss'}">${map.score2}</span>`;
                    html += `</span>`;
                    html += '</div>';
                });
                html += '</div>';
            }

            html += '</div>';

            // --- Veto ---
            if (match.veto) {
                html += '<div class="md-veto">';
                const parts = match.veto.split(',').map(s => s.trim());
                parts.forEach(part => {
                    let cls = 'md-veto-item';
                    if (part.includes('bans')) cls += ' md-veto-ban';
                    else if (part.includes('picks')) cls += ' md-veto-pick';
                    else cls += ' md-veto-decider';
                    html += `<span class="${cls}">${part}</span>`;
                });
                html += '</div>';
            }

            // --- Map tabs ---
            html += '<div class="md-map-tabs" id="md-map-tabs">';
            html += '<button class="md-map-tab active" onclick="switchMap(\'all\')">All Maps</button>';
            if (match.mapDetails) {
                match.mapDetails.forEach((md, i) => {
                    html += `<button class="md-map-tab" onclick="switchMap(${i})">${md.name}</button>`;
                });
            }
            html += '</div>';

            // --- Stats area ---
            html += '<div id="md-stats-area"></div>';

            container.innerHTML = html;
            renderStats('all');
        }

        function switchMap(mapIndex) {
            currentMapTab = mapIndex;
            const btns = document.querySelectorAll('#md-map-tabs .md-map-tab');
            btns.forEach((btn, i) => {
                btn.classList.toggle('active', i === 0 ? mapIndex === 'all' : i - 1 === mapIndex);
            });
            renderStats(mapIndex);
        }

        function renderStats(mapIndex) {
            const area = document.getElementById('md-stats-area');
            if (mapIndex === 'all') {
                renderAllMaps(area);
            } else {
                renderSingleMap(area, match.mapDetails[mapIndex]);
            }
        }

        function renderStreamEmbed(link) {
            const vidMatch = link.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            if (!vidMatch) return '';
            return `<div class="md-stream-embed">
                <iframe src="https://www.youtube.com/embed/${vidMatch[1]}" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            </div>`;
        }

        function renderAllMaps(area) {
            if (!match.combinedStats || match.combinedStats.length === 0) {
                area.innerHTML = '<p class="stats-error">No stats available.</p>';
                return;
            }

            const winner = match.score1 > match.score2 ? 1 : 2;
            const statCols = ['R1.0', 'ACS', 'K', 'D', 'A', 'PlusMinus', 'KAST', 'ADR', 'HS%', 'FK', 'FD', 'PlusMinus2'];
            const displayHeaders = ['R', 'ACS', 'K', 'D', 'A', '+/-', 'KAST', 'ADR', 'HS%', 'FK', 'FD', 'FK±'];

            let html = '<div class="md-map-section">';

            match.combinedStats.forEach((teamStats, teamIdx) => {
                const isWinner = (teamIdx === 0 && winner === 1) || (teamIdx === 1 && winner === 2);

                html += `<div class="md-team-stats ${isWinner ? 'md-team-stats-win' : 'md-team-stats-loss'}">`;
                html += `<div class="md-team-stats-header">`;
                html += `<span class="md-team-stats-name">${teamStats.teamName}</span>`;
                html += `<span class="md-team-stats-abbr">${teamStats.team}</span>`;
                html += `</div>`;

                html += '<div class="md-stats-scroll"><table class="md-stats-table">';
                html += '<thead><tr>';
                html += '<th class="md-col-player">Player</th>';
                displayHeaders.forEach(h => html += `<th>${h}</th>`);
                html += '</tr></thead><tbody>';

                const sorted = [...teamStats.players].sort((a, b) =>
                    (parseFloat(b['R1.0']) || 0) - (parseFloat(a['R1.0']) || 0)
                );

                sorted.forEach(player => {
                    html += '<tr>';
                    html += `<td class="md-col-player">${player.Player || ''}</td>`;
                    statCols.forEach(col => {
                        let val = player[col];
                        if (val == null || val === '') {
                            html += '<td>-</td>';
                        } else if (col === 'R1.0') {
                            html += `<td class="md-col-rating">${parseFloat(val).toFixed(2)}</td>`;
                        } else if (col === 'KAST' || col === 'HS%') {
                            html += `<td>${(parseFloat(val) * 100).toFixed(0)}%</td>`;
                        } else if (col === 'ACS' || col === 'ADR') {
                            html += `<td>${Math.round(parseFloat(val))}</td>`;
                        } else if (col === 'PlusMinus' || col === 'PlusMinus2') {
                            const num = parseInt(val);
                            const cls = num > 0 ? 'md-stat-pos' : num < 0 ? 'md-stat-neg' : '';
                            const prefix = num > 0 ? '+' : '';
                            html += `<td class="${cls}">${prefix}${num}</td>`;
                        } else {
                            html += `<td>${val}</td>`;
                        }
                    });
                    html += '</tr>';
                });

                html += '</tbody></table></div></div>';
            });

            html += '</div>';

            // VOD embed
            const link = match.streamLink;
            if (link) {
                html += `<div class="md-stream-link"><span class="md-stream-label">VOD:</span></div>`;
                html += renderStreamEmbed(link);
            }

            area.innerHTML = html;
        }

        function renderSingleMap(area, md) {
            if (!md) {
                area.innerHTML = '<p class="stats-error">No data for this map.</p>';
                return;
            }

            const mw = md.score1 > md.score2 ? 1 : 2;
            let html = '';

            // Map score header
            html += '<div class="md-single-map-header">';
            html += `<span class="md-single-map-name">${md.name}</span>`;
            html += '<div class="md-single-map-score">';
            html += `<span class="md-sms-team">${match.team1}</span>`;
            html += `<span class="md-sms-num ${mw === 1 ? 'md-pill-win' : 'md-pill-loss'}">${md.score1}</span>`;
            html += `<span class="md-sms-sep">-</span>`;
            html += `<span class="md-sms-num ${mw === 2 ? 'md-pill-win' : 'md-pill-loss'}">${md.score2}</span>`;
            html += `<span class="md-sms-team">${match.team2}</span>`;
            html += '</div>';
            html += '</div>';

            // Round timeline
            if (md.rounds && md.rounds.length > 0) {
                html += renderTimeline(md);
            }

            // Per-map stats table
            if (md.stats && md.stats.length > 0) {
                const winner = md.score1 > md.score2 ? 1 : 2;
                html += renderMapStatsTable(md.stats, winner);
            }

            // VOD embed
            const link = md.streamLink || match.streamLink;
            if (link) {
                html += `<div class="md-stream-link"><span class="md-stream-label">VOD:</span></div>`;
                html += renderStreamEmbed(link);
            }

            area.innerHTML = html;
        }

        function renderMapStatsTable(stats, winner) {
            const statCols = ['R1.0', 'ACS', 'K', 'D', 'A', 'PlusMinus', 'KAST', 'ADR', 'HS%', 'FK', 'FD', 'PlusMinus2'];
            const displayHeaders = ['R', 'ACS', 'K', 'D', 'A', '+/-', 'KAST', 'ADR', 'HS%', 'FK', 'FD', 'FK±'];
            let html = '<div class="md-map-section">';

            stats.forEach((teamStats, teamIdx) => {
                const isWinner = (teamIdx === 0 && winner === 1) || (teamIdx === 1 && winner === 2);

                html += `<div class="md-team-stats ${isWinner ? 'md-team-stats-win' : 'md-team-stats-loss'}">`;
                html += `<div class="md-team-stats-header">`;
                html += `<span class="md-team-stats-name">${teamStats.teamName}</span>`;
                html += `<span class="md-team-stats-abbr">${teamStats.team}</span>`;
                html += `</div>`;

                html += '<div class="md-stats-scroll"><table class="md-stats-table">';
                html += '<thead><tr>';
                html += '<th class="md-col-player">Player</th>';
                html += '<th class="md-col-agent">Agent</th>';
                displayHeaders.forEach(h => html += `<th>${h}</th>`);
                html += '</tr></thead><tbody>';

                const sorted = [...teamStats.players].sort((a, b) =>
                    (parseFloat(b['R1.0']) || 0) - (parseFloat(a['R1.0']) || 0)
                );

                sorted.forEach(player => {
                    html += '<tr>';
                    html += `<td class="md-col-player">${player.Player || ''}</td>`;
                    const agent = player.Agent;
                    html += agent && agent !== '-'
                        ? `<td class="md-col-agent"><img src="../data/agents/${agent}_icon.png" alt="${agent}" class="md-agent-icon" title="${agent}" onerror="this.outerHTML='${agent}'"></td>`
                        : '<td class="md-col-agent">-</td>';
                    statCols.forEach(col => {
                        let val = player[col];
                        if (val == null || val === '') {
                            html += '<td>-</td>';
                        } else if (col === 'R1.0') {
                            html += `<td class="md-col-rating">${parseFloat(val).toFixed(2)}</td>`;
                        } else if (col === 'KAST' || col === 'HS%') {
                            html += `<td>${(parseFloat(val) * 100).toFixed(0)}%</td>`;
                        } else if (col === 'ACS' || col === 'ADR') {
                            html += `<td>${Math.round(parseFloat(val))}</td>`;
                        } else if (col === 'PlusMinus' || col === 'PlusMinus2') {
                            const num = parseInt(val);
                            const cls = num > 0 ? 'md-stat-pos' : num < 0 ? 'md-stat-neg' : '';
                            const prefix = num > 0 ? '+' : '';
                            html += `<td class="${cls}">${prefix}${num}</td>`;
                        } else {
                            html += `<td>${val}</td>`;
                        }
                    });
                    html += '</tr>';
                });

                html += '</tbody></table></div></div>';
            });

            html += '</div>';
            return html;
        }

        function renderTimeline(md) {
            const rounds = md.rounds;
            const firstHalf = rounds.filter(r => r.round <= 12);
            const secondHalf = rounds.filter(r => r.round > 12);

            let t1First = firstHalf.filter(r => r.winner === 1).length;
            let t2First = firstHalf.filter(r => r.winner === 2).length;

            const maxRound = Math.max(...rounds.map(x => x.round));
            const totalFromScore = md.score1 + md.score2;
            const hasOT = maxRound > 24 || totalFromScore > 24;

            const t1Reg2 = rounds.filter(r => r.round >= 13 && r.round <= 24 && r.winner === 1).length;
            const t2Reg2 = rounds.filter(r => r.round >= 13 && r.round <= 24 && r.winner === 2).length;
            const t1OT = hasOT ? md.score1 - t1First - t1Reg2 : 0;
            const t2OT = hasOT ? md.score2 - t2First - t2Reg2 : 0;

            let html = '<div class="md-timeline">';

            if (hasOT) {
                html += '<div class="md-timeline-row md-timeline-labels">';
                html += '<span class="md-timeline-team"></span>';
                html += '<div class="md-timeline-rounds">';
                for (let r = 1; r <= 12; r++) html += '<div class="md-round" style="visibility:hidden"></div>';
                html += '<div class="md-timeline-halfscore"></div>';
                for (let r = 13; r <= 24; r++) html += '<div class="md-round" style="visibility:hidden"></div>';
                html += '<div class="md-timeline-halfscore"></div>';
                html += '<div class="md-timeline-halfscore md-ot-label">OT</div>';
                for (let r = 25; r <= maxRound; r++) html += '<div class="md-round" style="visibility:hidden"></div>';
                html += '<div class="md-timeline-halfscore"></div>';
                html += '</div></div>';
            }

            html += renderTimelineRow(match.team1, 1, rounds, maxRound, hasOT, t1First, hasOT ? t1Reg2 : rounds.filter(r => r.round > 12 && r.winner === 1).length, t1OT);
            html += renderTimelineRow(match.team2, 2, rounds, maxRound, hasOT, t2First, hasOT ? t2Reg2 : rounds.filter(r => r.round > 12 && r.winner === 2).length, t2OT);

            html += '</div>';
            return html;
        }

        function renderTimelineRow(teamName, teamNum, rounds, maxRound, hasOT, firstHalfScore, secondHalfScore, otScore) {
            let html = '<div class="md-timeline-row">';
            html += `<span class="md-timeline-team">${teamName}</span>`;
            html += '<div class="md-timeline-rounds">';
            for (let r = 1; r <= 12; r++) {
                const rd = rounds.find(x => x.round === r);
                html += (rd && rd.winner === teamNum)
                    ? `<div class="md-round md-round-${rd.side}" title="R${r}"></div>`
                    : '<div class="md-round md-round-empty"></div>';
            }
            html += `<div class="md-timeline-halfscore">${firstHalfScore}</div>`;
            for (let r = 13; r <= 24; r++) {
                const rd = rounds.find(x => x.round === r);
                html += (rd && rd.winner === teamNum)
                    ? `<div class="md-round md-round-${rd.side}" title="R${r}"></div>`
                    : '<div class="md-round md-round-empty"></div>';
            }
            html += `<div class="md-timeline-halfscore">${secondHalfScore}</div>`;
            if (hasOT) {
                html += '<div class="md-timeline-halfscore"></div>';
                for (let r = 25; r <= maxRound; r++) {
                    const rd = rounds.find(x => x.round === r);
                    html += (rd && rd.winner === teamNum)
                        ? `<div class="md-round md-round-${rd.side}" title="R${r}"></div>`
                        : '<div class="md-round md-round-empty"></div>';
                }
                html += `<div class="md-timeline-halfscore">${otScore}</div>`;
            }
            html += '</div></div>';
            return html;
        }

        loadMatch();
    </script>
</body>
</html>